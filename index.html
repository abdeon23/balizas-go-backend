<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Balizas GO – DATEX2 + Ayuda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; padding:0; font-family:system-ui,sans-serif; background:radial-gradient(circle at top,#1f2937 0,#020617 60%); color:#f9fafb; overflow:hidden; }
    #app { display:flex; flex-direction:column; height:100%; }
    header { padding:8px 14px; background:linear-gradient(90deg,#0f172a,#111827); display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.5); z-index:1000; }
    .logo { font-weight:800; letter-spacing:0.1em; font-size:1rem; color:#38bdf8; display:flex; align-items:center; gap:6px; }
    .logo-badge { width:18px; height:18px; border-radius:50%; background:radial-gradient(circle,#f97316,#be123c); box-shadow:0 0 12px rgba(248,113,113,0.8); }
    .scoreboard { display:flex; gap:10px; align-items:center; font-size:0.8rem; }
    .badge { background: rgba(15,23,42,0.9); border-radius:999px; padding:4px 10px; display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(55,65,81,0.9); }
    .badge span.value { font-weight:700; color:#facc15; margin-right:4px; }
    #main { display:grid; grid-template-columns:minmax(0,3fr) minmax(260px,320px); flex:1; min-height:0; }
    #map { height:100%; width:100%; }
    #side-panel { background:#020617; border-left:1px solid rgba(30,64,175,0.6); padding:10px; display:flex; flex-direction:column; gap:10px; }
    .panel-section { background: rgba(15,23,42,0.95); border-radius:10px; padding:8px 10px; border:1px solid rgba(55,65,81,0.9); font-size:0.8rem; }
    .panel-section h3 { margin-top:0; font-size:0.9rem; margin-bottom:4px; }
    .ad-banner { background: radial-gradient(circle,#facc15 0,#f97316 30%,#9f1239 80%); border-radius:10px; padding:8px 10px; color:#111827; cursor:pointer; font-size:0.8rem; }
    .toast { position:fixed; top:70px; left:50%; transform:translateX(-50%); background:rgba(34,197,94,0.95); padding:7px 14px; border-radius:999px; opacity:0; transition:opacity 0.25s ease-out; z-index:2000; font-size:0.8rem; }
    .toast.show { opacity:1; }
    .leaflet-marker-icon.helped { filter: hue-rotate(100deg) saturate(200%); }
    .icon-helped img { filter: hue-rotate(120deg) brightness(1.2); } /* verde */
    @media (max-width: 800px) { #main { grid-template-columns:1fr; grid-template-rows:2fr auto; } #side-panel { height:260px; } }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="logo">
        <div class="logo-badge"></div>
        BALIZAS GO – DATEX2
      </div>
      <div class="scoreboard">
        <div class="badge"><span class="value" id="level">1</span> Nivel</div>
        <div class="badge"><span class="value" id="xp">0/100</span> XP</div>
        <div class="badge"><span class="value" id="helps">10</span> Ayudas</div>
      </div>
    </header>
    <div id="main">
      <div id="map"></div>
      <aside id="side-panel">
        <section class="panel-section">
          <h3>Misiones (concepto)</h3>
          <ul style="margin:0;padding-left:16px;">
            <li>Ayuda a varias balizas.</li>
            <li>Deja el mapa limpio (sin pendientes).</li>
          </ul>
        </section>
        <section class="panel-section">
          <h3>Anuncio (+Ayudas)</h3>
          <div class="ad-banner" id="ad-banner">
            Pulsa aquí para "ver un anuncio" y obtener <strong>+3 ayudas</strong> extra.
          </div>
        </section>
        <section class="panel-section">
          <h3>Estado del mapa</h3>
          <p id="map-status">Cargando balizas…</p>
        </section>
      </aside>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const toastEl = document.getElementById("toast");
    const xpEl = document.getElementById("xp");
    const levelEl = document.getElementById("level");
    const helpsEl = document.getElementById("helps");
    const mapStatusEl = document.getElementById("map-status");
    const adBannerEl = document.getElementById("ad-banner");

    let username = prompt("Introduce tu nombre de jugador:");
    let xp = 0, level = 1, xpToNext = 100, helps = 10;
    let beacons = [], beaconMarkers = new Map(), pendingHelps = 0;

    const map = L.map("map").setView([40.4,-3.7],6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

    const iconNeedsHelp = L.icon({
    iconUrl: "https://raw.githubusercontent.com/abdeon23/balizas-go-backend/main/baliza.png",
    iconSize: [32, 32], // tamaño en píxeles
    iconAnchor: [16, 16], // centro del icono
    popupAnchor: [0, -16], // dónde aparece el popup
    });

    const iconHelped = L.icon({
    iconUrl: "https://raw.githubusercontent.com/abdeon23/balizas-go-backend/main/baliza.png",
    className: "icon-helped", // podemos usar CSS para filtro verde
    iconSize: [32, 32],
    iconAnchor: [16, 16],
    popupAnchor: [0, -16],
    });

    function showToast(msg){toastEl.textContent=msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),1500);}
    function updateUI(){xpEl.textContent=`${xp}/${xpToNext}`; levelEl.textContent=level; helpsEl.textContent=helps; pendingHelps=beacons.filter(b=>b.needsHelp).length; mapStatusEl.textContent=`${pendingHelps} balizas necesitan ayuda`;}
    function addXP(amount){xp+=amount;if(xp>=xpToNext){level++;xp=0;xpToNext=Math.round(xpToNext*1.4+50);showToast("¡Subes de nivel!");}updateUI();}
    function handleSendHelp(b){if(!b.needsHelp){showToast("Esta baliza ya está ayudada");return;} if(helps<=0){showToast("No te quedan ayudas. Usa el anuncio para recargar.");return;} helps--; b.needsHelp=false; const marker=beaconMarkers.get(b.id); if(marker) marker.setIcon(iconHelped); addXP(20); showToast("Ayuda enviada (+20 XP)"); updateUI(); if(pendingHelps===0){addXP(80); showToast("¡Mapa limpio! Bonus +80 XP");}}

    async function loadBeaconsFromAPI(){
      try{
        const res = await fetch("https://balizas-go-backend-production.up.railway.app/api/balizas");
        const data = await res.json();
        beacons = data.filter(item=>item.lat&&!isNaN(item.lat)&&item.lng&&!isNaN(item.lng)).map((item,i)=>({
          id: item.id||`b${i}`,
          lat: parseFloat(item.lat),
          lng: parseFloat(item.lng),
          name:"Baliza DATEX2",
          description:item.municipality?`Localidad: ${item.municipality}`:"Origen: DATEX2",
          needsHelp:true
        }));
        console.log("Balizas cargadas:",beacons);
      }catch(e){console.error("Error cargando balizas:",e); beacons=[];}
    }

    function initMap(){
      beacons.forEach(b=>{
        try{
          const marker = L.marker([b.lat,b.lng],{icon:b.needsHelp?iconNeedsHelp:iconHelped}).addTo(map);
          marker.bindPopup(`<strong>Baliza en apuros</strong><br>${b.description}<br><em>Pulsa para enviar ayuda</em>`);
          marker.on("click",()=>handleSendHelp(b));
          beaconMarkers.set(b.id,marker);
        }catch(e){console.warn("Error añadiendo baliza:",b,e);}
      });
      if(beaconMarkers.size>0){
        const group=new L.featureGroup(Array.from(beaconMarkers.values()));
        map.fitBounds(group.getBounds().pad(0.2));
      }
      updateUI();
    }

    adBannerEl.addEventListener("click",()=>{helps+=3; showToast("Has visto un anuncio (simulado): +3 ayudas"); updateUI();});

    loadBeaconsFromAPI().then(()=>initMap());
  </script>
</body>
</html>
